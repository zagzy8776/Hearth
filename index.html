<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Human Thread</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:italic,wght@400;600&family=EB+Garamond&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --paper: #f9f7f1;
            --ink: #2c2c2c;
            --accent: #8c6a5e;
            --border: rgba(44, 44, 44, 0.1);
        }

        body {
            background-color: var(--paper);
            color: var(--ink);
            font-family: 'EB Garamond', serif;
            margin: 0;
            line-height: 1.6;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, transparent 50%, rgba(0,0,0,0.3) 100%);
            pointer-events: none;
            z-index: -1;
        }

        nav { display: flex; justify-content: space-between; padding: 2rem 10%; border-bottom: 1px solid var(--border); }
        .logo { font-size: 1.5rem; font-weight: 600; font-style: italic; }

        main { max-width: 800px; margin: 0 auto; padding: 2rem; text-align: center; }
        
        /* Map Styling */
        #map-section { padding: 2rem 0; }
        #map { height: 500px; width: 100%; border: 1px solid var(--ink); box-shadow: 10px 10px 0px rgba(140, 106, 94, 0.2); }

        /* Modal / Writing Desk */
        .modal { 
            display: none; position: fixed; z-index: 9999; 
            left: 0; top: 0; width: 100%; height: 100%; 
            background-color: rgba(44, 44, 44, 0.8); backdrop-filter: blur(8px); 
        }
        .modal-content { 
            background-color: #f9f7f1; margin: 5% auto; padding: 2rem; 
            width: 90%; max-width: 600px; border: 1px solid var(--ink); 
            box-shadow: 20px 20px 0px var(--accent); position: relative; 
            text-align: left; color: var(--ink);
        }

        /* Buttons */
        .primary-btn { background-color: var(--ink); color: var(--paper); border: none; padding: 0.8rem 2rem; cursor: pointer; }
        
        /* Markers */
        .ember-marker { background: #e67e22; border: 2px solid #fff; border-radius: 50%; box-shadow: 0 0 10px #f39c12; }
        .ember-marker:hover { box-shadow: 0 0 20px #f39c12, 0 0 40px #d35400; }

        /* Breathe Circle */
        #breathe-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--accent);
            margin: 20px auto;
            animation: breathe 4s infinite;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Ash Effect */
        @keyframes ash {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.5) rotate(45deg); }
        }

        /* Drop Effect */
        @keyframes drop {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(100vh); }
        }

        /* Ink Bleed */
        .ink-bleed { animation: inkBleed 2s ease-out; }
        @keyframes inkBleed { 0% { opacity: 0; transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }

        /* Gratitude Wall */
        #gratitude-feed {
            height: 100px;
            overflow: hidden;
            position: relative;
        }

        #gratitude-feed div {
            animation: scroll 20s linear infinite;
        }

        @keyframes scroll {
            0% { transform: translateY(100%); }
            100% { transform: translateY(-100%); }
        }
    </style>
</head>
<body>

<nav>
    <div class="logo">The Human Thread</div>
    <div>
        <button id="hearth-btn" onclick="toggleHearth()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">ðŸ’¤</button>
        <div id="moon-phase"></div>
    </div>
</nav>

<main>
    <section class="hero">
        <h1>The Human Thread</h1>
        <p style="font-size: 1.4rem; font-style: italic;">A sanctuary built to remind us that we are more than data points.</p>
    </section>

    <section id="map-section">
        <div id="map"></div>
        <p id="trace-counter" style="font-style: italic; margin-top: 10px;">Gathering the thread...</p>
    </section>

    <section id="sand-script" style="margin-top: 50px; border-top: 1px solid var(--border); padding-top: 30px;">
        <h3>The Sand Script</h3>
        <p>Write what you must let go of. Choose fade time and begin.</p>
        <input type="radio" name="fade-time" value="10">10s 
        <input type="radio" name="fade-time" value="60" checked>60s<br>
        <textarea id="sand-text" style="width:100%; height:100px; font-family:serif; padding:10px;"></textarea><br>
        <p id="mirror-prompt" style="margin-top:10px; display:none;">Now, write something kind to yourself.</p>
        <button class="primary-btn" onclick="beginFade()" style="margin-top:10px;">Begin the Fade</button>
        <button class="primary-btn" onclick="dropWorry()" style="margin-top:10px; margin-left:10px;">Drop into Ocean</button>
        <div id="breathe-circle"></div>
    </section>



    <section id="perspective-bridge" style="margin-top: 50px; border-top: 1px solid var(--border); padding-top: 30px;">
        <h3>The Perspective Bridge</h3>
        <p>This section is about the beauty of incomplete things. Co-authorship: It allows a stranger to start a sentence or a thought, and another strangerâ€”perhaps thousands of miles awayâ€”to finish it.</p>
        <textarea id="start-thought" placeholder="Start a sentence or thought" style="width:100%; height:100px; padding:10px;"></textarea><br>
        <button class="primary-btn" onclick="sendStartThought()" style="margin-top:10px;">Start Thought</button>
        <button class="primary-btn" onclick="loadStartedThought()" style="margin-top:10px; margin-left:10px;">Find a Thought to Finish</button>
        <div id="finish-section" style="margin-top:20px; display:none;">
            <h4>Finish a Thought</h4>
            <p id="started-thought"></p>
            <textarea id="finish-text" placeholder="Complete the thought..." style="width:100%; height:100px; padding:10px;"></textarea><br>
            <button class="primary-btn" onclick="finishThought()" style="margin-top:10px;">Complete Thought</button>
        </div>
        <div id="received-letter" style="margin-top:20px; display:none; padding:10px; border:1px solid var(--border);">
            <h4>A Completed Thought</h4>
            <p id="thought-content"></p>
        </div>
    </section>

    <button class="primary-btn" onclick="goodbye()" style="margin-top: 50px;">Go Outside</button>
</main>

<div id="writing-desk-modal" class="modal">
    <div class="modal-content">
        <h2>Leave a Trace</h2>
        <input type="text" id="user-location" placeholder="City, Country" style="width:100%; padding:10px; margin-bottom:10px;">
        <select id="user-category" style="width:100%; padding:10px; margin-bottom:10px;">
            <option value="Joy">Joy</option>
            <option value="Loss">Loss</option>
            <option value="Wonder">Wonder</option>
        </select>
        <input type="text" id="user-name" placeholder="Your name (optional)" style="width:100%; padding:10px; margin-bottom:10px;">
        <input type="text" id="user-photourl" placeholder="Photo URL (optional)" style="width:100%; padding:10px; margin-bottom:10px;">
        <textarea id="user-story" placeholder="What is the story of this place?" style="width:100%; height:150px; padding:10px;"></textarea>
        <input type="hidden" id="user-coords">
        <button class="primary-btn" onclick="submitToSheet()">Place on Map</button>
        <button onclick="closeDesk()" style="background:none; border:none; cursor:pointer; margin-left:10px;">Cancel</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
    const api_url = 'https://sheetdb.io/api/v1/tm5l5bvsafoxn';
    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    const markers = L.markerClusterGroup();
    map.addLayer(markers);

    // Day/Night Cycle
    const hour = new Date().getHours();
    if (hour >= 6 && hour < 18) {
        document.documentElement.style.setProperty('--paper', '#f9f7f1');
        document.documentElement.style.setProperty('--ink', '#2c2c2c');
    } else {
        document.documentElement.style.setProperty('--paper', '#2c2c2c');
        document.documentElement.style.setProperty('--ink', '#f9f7f1');
    }

    // Shareable Links
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('lat') && urlParams.has('lng')) {
        map.setView([urlParams.get('lat'), urlParams.get('lng')], 10);
    }

    function loadMarkers() {
        fetch(api_url).then(res => res.json()).then(data => {
            const liveData = data.filter(i => i.Status && i.Status.trim().toLowerCase() === 'live');
            liveData.forEach(item => {
                const color = {Joy: '#e67e22', Loss: '#9b59b6', Wonder: '#3498db'}[item.Category] || '#e67e22';
                const icon = L.divIcon({ className: 'ember-marker', iconSize: [10, 10], html: `<div style="background:${color}"></div>` });
                const marker = L.marker([item.Lat, item.Lng], {icon: icon});
                const date = new Date(item.Date);
                const now = new Date();
                const months = (now - date) / (1000 * 60 * 60 * 24 * 30);
                const moons = Math.floor(months);
                marker.bindPopup(`<div style="font-family:serif; color:#2c2c2c;">${item.PhotoURL ? '<img src="' + item.PhotoURL + '" style="max-width:100px; margin-bottom:10px;"><br>' : ''}<b>${item.Location}</b><br>"${item.Story}"<br><small style="font-family: 'Dancing Script', cursive;">${item.Name || 'Anonymous'}</small><br><small>${moons} moons ago</small><br><button onclick="hug(this, '${item.id}')">Someone felt this (${item.Hugs || 0})</button></div>`);
                markers.addLayer(marker);
            });
            document.getElementById('trace-counter').innerText = liveData.length + " Traces in the Thread";
        });
    }

    function hug(btn, id) {
        const current = parseInt(btn.textContent.match(/\d+/)[0]);
        fetch(api_url + '/' + id, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({data: {Hugs: current + 1}})
        }).then(() => {
            btn.textContent = `Someone felt this (${current + 1})`;
        });
    }

    map.on('click', function(e) {
        document.getElementById('user-coords').value = e.latlng.lat + "," + e.latlng.lng;
        document.getElementById('writing-desk-modal').style.display = 'block';
    });

    function closeDesk() { document.getElementById('writing-desk-modal').style.display = 'none'; }

    function submitToSheet() {
        const coords = document.getElementById('user-coords').value.split(',');
        fetch(api_url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({data: [{
                Story: document.getElementById('user-story').value,
                Location: document.getElementById('user-location').value,
                Category: document.getElementById('user-category').value,
                Name: document.getElementById('user-name').value,
                PhotoURL: document.getElementById('user-photourl').value,
                Lat: coords[0], Lng: coords[1],
                Date: new Date().toLocaleDateString(), Status: "",
                Hugs: 0
            }]})
        }).then(() => { alert("Saved to the ledger."); location.reload(); });
    }

    function beginFade() {
        const el = document.getElementById('sand-text');
        const time = document.querySelector('input[name="fade-time"]:checked').value * 1000;
        el.style.animation = `ash ${time}ms linear forwards`;
        setTimeout(() => { el.value = ""; el.style.animation = ""; document.getElementById('mirror-prompt').style.display = 'block'; }, time);
    }

    function goodbye() {
        document.querySelector('main').style.display = 'none';
        document.body.innerHTML = '<div style="text-align:center; padding:50px; font-size:2rem;">Go outside and breathe.</div>';
    }

    loadMarkers();

    function getMoonPhase() {
        const now = new Date();
        const cycle = 29.53;
        const newMoon = new Date(2023, 0, 1);
        const days = (now - newMoon) / (1000 * 60 * 60 * 24);
        const phase = (days % cycle) / cycle;
        const phases = ['ðŸŒ‘', 'ðŸŒ’', 'ðŸŒ“', 'ðŸŒ”', 'ðŸŒ•', 'ðŸŒ–', 'ðŸŒ—', 'ðŸŒ˜'];
        const index = Math.floor(phase * 8) % 8;
        return phases[index];
    }

    document.getElementById('moon-phase').innerText = getMoonPhase();

    let hearthPlaying = false;
    function toggleHearth() {
        hearthPlaying = !hearthPlaying;
        document.getElementById('hearth-btn').textContent = hearthPlaying ? 'ðŸ”¥' : 'ðŸ’¤';
    }

    window.addEventListener('load', () => {
        document.body.classList.add('ink-bleed');
    });

    function sendStartThought() {
        const start = document.getElementById('start-thought').value.trim();
        if (start) {
            fetch(api_url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({data: [{Start: start, Type: 'StartedThought', Date: new Date().toISOString()}]})
            }).then(() => {
                alert("Thought started in the bridge.");
                document.getElementById('start-thought').value = '';
                loadCompletedThought();
            });
        }
    }

    function loadStartedThought() {
        fetch(api_url + '?Type=StartedThought').then(res => res.json()).then(data => {
            if (data.length > 0) {
                const random = data[Math.floor(Math.random() * data.length)];
                document.getElementById('started-thought').innerText = random.Start;
                document.getElementById('finish-section').style.display = 'block';
            }
        });
    }

    function finishThought() {
        const start = document.getElementById('started-thought').innerText;
        const finish = document.getElementById('finish-text').value.trim();
        if (finish) {
            fetch(api_url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({data: [{Start: start, Finish: finish, Type: 'CompletedThought', Date: new Date().toISOString()}]})
            }).then(() => {
                alert("Thought completed in the bridge.");
                document.getElementById('finish-text').value = '';
                document.getElementById('finish-section').style.display = 'none';
                loadCompletedThought();
            });
        }
    }

    function loadCompletedThought() {
        fetch(api_url + '?Type=CompletedThought').then(res => res.json()).then(data => {
            if (data.length > 0) {
                const random = data[Math.floor(Math.random() * data.length)];
                document.getElementById('thought-content').innerText = random.Start + ' ' + random.Finish;
                document.getElementById('received-letter').style.display = 'block';
            }
        });
    }

    loadCompletedThought();

    function dropWorry() {
        const el = document.getElementById('sand-text');
        el.style.animation = 'drop 3s linear forwards';
        setTimeout(() => { el.value = ""; el.style.animation = ""; }, 3000);
    }
</script>
</body>
</html>
