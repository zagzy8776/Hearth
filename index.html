<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hearth | A Human Thread</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:italic,wght@400;600&family=EB+Garamond&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --parchment: #fdf5e6;
            --ink: #2c3e50;
            --ember: #d35400;
            --gold: #f39c12;
        }

        body, html { margin: 0; padding: 0; height: 100%; background: #1a1a1a; overflow: hidden; }
        #map { height: 100vh; width: 100vw; background: #0f0f0f; }

        /* Writing Desk Styling */
        #writing-desk {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 90%; max-width: 400px;
            background: var(--parchment);
            padding: 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            border-left: 8px solid var(--ember);
            font-family: 'EB Garamond', serif;
        }

        input, textarea {
            width: 100%; margin: 10px 0; padding: 10px;
            border: 1px solid #ccc; background: rgba(255,255,255,0.5);
            font-family: 'EB Garamond', serif; font-size: 1.1em;
        }

        button {
            background: var(--ember); color: white; border: none;
            padding: 10px 20px; cursor: pointer; transition: 0.3s;
        }

        button:hover { background: var(--gold); }

        /* The Counter */
        #trace-counter {
            position: fixed;
            bottom: 20px; right: 20px;
            color: var(--parchment);
            font-family: 'Cormorant Garamond', serif;
            font-style: italic;
            font-size: 1.2em;
            z-index: 1000;
            text-shadow: 2px 2px 4px black;
        }

        /* The Ember Markers */
        .ember-marker {
            background: var(--ember);
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 10px var(--gold), 0 0 20px var(--ember);
            animation: flicker 2s infinite alternate;
        }

        @keyframes flicker {
            from { opacity: 0.7; transform: scale(1); }
            to { opacity: 1; transform: scale(1.2); }
        }

        /* Popup Parchment Styling */
        .leaflet-popup-content-wrapper {
            background: var(--parchment);
            color: var(--ink);
            border-radius: 0;
            font-family: 'Cormorant Garamond', serif;
        }

        .popup-inner { font-size: 1.2em; padding: 5px; }
        .popup-inner i { color: var(--ember); font-size: 0.9em; }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="trace-counter">Connecting to the Thread...</div>

    <!-- Daily Spark -->
    <div class="daily-spark" style="position: fixed; top: 20px; left: 20px; background: rgba(255,255,255,0.05); padding: 20px; border: 1px solid #333; max-width: 300px; z-index: 1000;">
        <h4 style="margin:0; color:#f39c12;">Today's Spark:</h4>
        <p>"What is the most beautiful thing you saw today?"</p>
    </div>

    <!-- Sand Script -->
    <div id="sand-script" style="position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.8); padding: 20px; border: 1px solid #444; max-width: 300px; z-index: 1000; display: none;">
        <h2 style="margin-top:0; color: white;">The Sand Script</h2>
        <p style="color: #ccc;">Write something you need to let go of. It will fade away in 60 seconds.</p>
        <textarea id="sand-text" placeholder="Release it here..." style="width:100%; height:100px; background:transparent; color:white; border:1px solid #444;"></textarea>
        <button onclick="beginFade()" style="margin-top:10px; background: var(--ember); color: white; border: none; padding: 5px 10px;">Begin the Fade</button>
    </div>

    <!-- Perspective Bridge -->
    <div id="bridge" style="position: fixed; bottom: 60px; left: 20px; background: rgba(0,0,0,0.8); padding: 20px; border: 1px solid #444; max-width: 300px; z-index: 1000; display: none;">
        <h2 style="margin-top:0; color: white;">The Perspective Bridge</h2>
        <div style="border-left: 3px solid #d35400; padding-left: 15px;">
            <p style="color: #ccc;"><strong>Current Opening Line:</strong> <i>Love is in the air...</i></p>
            <input type="text" id="bridge-input" placeholder="Add the next line..." style="width: 100%; background: transparent; color: white; border: 1px solid #444; padding: 5px;">
            <button onclick="alert('Sent to the Thread')" style="margin-top:10px; background: var(--ember); color: white; border: none; padding: 5px 10px;">Submit</button>
        </div>
    </div>

    <div id="writing-desk">
        <h2 style="margin-top:0;">Leave a Trace</h2>
        <p>Where are you, and what story does this place hold?</p>
        <form id="story-form">
            <input type="text" id="user-location" placeholder="City, Country" required>
            <textarea id="user-story" placeholder="Your memory..." rows="4" required></textarea>
            <input type="hidden" id="user-coords">
            <button type="submit">Place on Map</button>
            <button type="button" onclick="closeDesk()" style="background:none; color:#666;">Cancel</button>
        </form>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const api_url = 'https://sheetdb.io/api/v1/tm5l5bvsafoxn';
        
        // Initialize Map
        const map = L.map('map', { zoomControl: false }).setView([20, 0], 2);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        const emberIcon = L.divIcon({ className: 'ember-marker', iconSize: [10, 10] });

        // Load Traces
        function loadTraces() {
            fetch(api_url)
                .then(res => res.json())
                .then(data => {
                    let liveCount = 0;
                    data.forEach(item => {
                        if (item.Status && item.Status.trim().toLowerCase() === "live") {
                            liveCount++;
                            const lat = parseFloat(item.Lat);
                            const lng = parseFloat(item.Lng);
                            if (!isNaN(lat) && !isNaN(lng)) {
                                L.marker([lat, lng], { icon: emberIcon }).addTo(map)
                                 .bindPopup(`
                                    <div class="popup-inner">
                                        <i>${item.Location}</i>
                                        <p>"${item.Story}"</p>
                                        <small style="display:block; text-align:right; opacity:0.6;">${item.Date}</small>
                                    </div>
                                 `);
                            }
                        }
                    });
                    document.getElementById('trace-counter').innerText = liveCount + " Traces in the Thread";
                });
        }

        // Open Writing Desk on Click
        map.on('click', function(e) {
            document.getElementById('user-coords').value = `${e.latlng.lat}, ${e.latlng.lng}`;
            document.getElementById('writing-desk').style.display = 'block';
        });

        function closeDesk() { document.getElementById('writing-desk').style.display = 'none'; }

        // Submit to Sheet
        document.getElementById('story-form').addEventListener("submit", function(e) {
            e.preventDefault();
            const coords = document.getElementById('user-coords').value.split(',');
            const payload = {
                data: [{
                    "Story": document.getElementById('user-story').value,
                    "Location": document.getElementById('user-location').value,
                    "Lat": coords[0].trim(),
                    "Lng": coords[1].trim(),
                    "Date": new Date().toLocaleDateString(),
                    "Status": ""
                }]
            };

            fetch(api_url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(() => {
                alert("The Keeper has received your trace. It will appear once approved.");
                location.reload();
            });
        });

        loadTraces();

        // Sand Script Fade Function
        function beginFade() {
            const el = document.getElementById('sand-text');
            el.style.transition = "opacity 60s linear";
            el.style.opacity = "0";
            setTimeout(() => {
                el.value = "";
                el.style.opacity = "1";
                el.style.transition = "none";
            }, 60000);
        }

        // Toggle functions for human elements
        function toggleSandScript() {
            const el = document.getElementById('sand-script');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        function toggleBridge() {
            const el = document.getElementById('bridge');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 's' || e.key === 'S') toggleSandScript();
            if (e.key === 'b' || e.key === 'B') toggleBridge();
        });
    </script>
</body>
</html>
